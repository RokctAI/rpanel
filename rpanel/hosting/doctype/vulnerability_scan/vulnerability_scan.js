        }
    }
});

function render_scan_results(frm) {
    let results = {};
    try {
        results = JSON.parse(frm.doc.scan_results);
    } catch (e) {
        console.error("Failed to parse scan results", e);
        return;
    }

    let html = `
        <div class="scan-results-container">
            ${render_wordpress_section(results.wordpress)}
            ${render_plugins_section(results.plugins)}
            ${render_malware_section(results.malware)}
            ${render_permissions_section(results.permissions)}
        </div>
    `;

    frm.set_df_property('scan_results_html', 'options', html);
}

function render_wordpress_section(wp) {
    if (!wp) return '';

    let status_class = wp.is_outdated ? 'text-danger' : 'text-success';
    let status_icon = wp.is_outdated ? '❌' : '✅';

    return `
        <div class="scan-section mb-4">
            <h4>WordPress Core</h4>
            <table class="table table-bordered">
                <tr>
                    <th width="30%">Current Version</th>
                    <td>${wp.current_version}</td>
                </tr>
                <tr>
                    <th>Latest Version</th>
                    <td>${wp.latest_version}</td>
                </tr>
                <tr>
                    <th>Status</th>
                    <td class="${status_class}">
                        ${status_icon} ${wp.is_outdated ? 'Outdated' : 'Up to date'}
                    </td>
                </tr>
            </table>
        </div>
    `;
}

function render_plugins_section(plugins) {
    if (!plugins || !plugins.length) return '';

    let rows = plugins.map(p => {
        let has_vuln = p.vulnerabilities && p.vulnerabilities.length > 0;
        let row_class = has_vuln ? 'table-danger' : '';

        return `
            <tr class="${row_class}">
                <td>${p.name}</td>
                <td>${p.version}</td>
                <td>
                    ${has_vuln ?
                `<span class="text-danger">${p.vulnerabilities.length} vulnerabilities found</span>` :
                '<span class="text-success">No known vulnerabilities</span>'}
                </td>
            </tr>
        `;
    }).join('');

    return `
        <div class="scan-section mb-4">
            <h4>Plugins (${plugins.length})</h4>
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Plugin</th>
                        <th>Version</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
            </table>
        </div>
    `;
}

function render_malware_section(malware) {
    if (!malware) return '';

    if (malware.error) {
        return `
            <div class="scan-section mb-4">
                <h4>Malware Scan</h4>
                <div class="alert alert-warning">${malware.error}</div>
            </div>
        `;
    }

    if (!Array.isArray(malware) || malware.length === 0) {
        return `
            <div class="scan-section mb-4">
                <h4>Malware Scan</h4>
                <div class="alert alert-success">✅ No malware detected</div>
            </div>
        `;
    }

    let rows = malware.map(m => `
        <tr class="table-danger">
            <td>${m.file}</td>
            <td>${m.threat}</td>
            <td><span class="badge badge-danger">CRITICAL</span></td>
        </tr>
    `).join('');

    return `
        <div class="scan-section mb-4">
            <h4 class="text-danger">Malware Detected (${malware.length})</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Threat</th>
                        <th>Severity</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
            </table>
        </div>
    `;
}

function render_permissions_section(permissions) {
    if (!permissions) return '';

    if (permissions.error) {
        return `
            <div class="scan-section mb-4">
                <h4>File Permissions</h4>
                <div class="alert alert-warning">${permissions.error}</div>
            </div>
        `;
    }

    if (!Array.isArray(permissions) || permissions.length === 0) {
        return `
            <div class="scan-section mb-4">
                <h4>File Permissions</h4>
                <div class="alert alert-success">✅ No permission issues found</div>
            </div>
        `;
    }

    let rows = permissions.map(p => `
        <tr class="table-warning">
            <td>${p.file}</td>
            <td>${p.issue}</td>
            <td><span class="badge badge-warning">MEDIUM</span></td>
        </tr>
    `).join('');

    return `
        <div class="scan-section mb-4">
            <h4 class="text-warning">Permission Issues (${permissions.length})</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Issue</th>
                        <th>Severity</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
            </table>
        </div>
    `;
}
