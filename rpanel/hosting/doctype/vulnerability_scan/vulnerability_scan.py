# Copyright (c) 2025, Rokct Holdings and contributors
# For license information, please see license.txt

"""
Vulnerability Scanner

Automated security scanning for WordPress websites:
- WordPress version check
- Plugin vulnerability check
- Malware detection (ClamAV)
- File permission audit
"""

import frappe
from frappe.model.document import Document
import os
import subprocess
import json
import requests
import re
from datetime import datetime, timedelta


class VulnerabilityScan(Document):
    def before_save(self):
        """Calculate total issues before saving"""
        self.total_issues = (
                self.critical_issues
                + self.high_issues
                + self.medium_issues
                + self.low_issues
        )


class VulnerabilityScanner:
    """Performs security scans on websites"""

    def __init__(self, website_name):
        self.website_name = website_name
        self.website = frappe.get_doc('Hosted Website', website_name)
        self.site_path = self.website.site_path
        self.results = {
                'wordpress': {},
                'plugins': [],
                'malware': [],
                'permissions': [],
                'summary': {}
        }

    def run_full_scan(self):
        """Run all security scans"""
        scan_doc = frappe.new_doc('Vulnerability Scan')
        scan_doc.website = self.website_name
        scan_doc.status = 'Running'
        scan_doc.save()
        frappe.db.commit()

        start_time = datetime.now()

        try:
            # Run individual scans
            self.scan_wordpress_version()
            self.scan_plugin_vulnerabilities()
            self.scan_malware()
            self.scan_file_permissions()

            # Calculate severity counts
            self._calculate_severity_counts(scan_doc)

            # Save results
            scan_doc.scan_results = json.dumps(self.results, indent=2)
            scan_doc.status = 'Completed'
            scan_doc.scan_duration = (datetime.now() - start_time).total_seconds()
            scan_doc.next_scan = datetime.now() + timedelta(days=1)

            # Send alert if issues found
            if scan_doc.total_issues > 0:
                self.send_alert_email(scan_doc)

        except Exception as e:
            scan_doc.status = 'Failed'
            frappe.log_error(f"Vulnerability scan failed: {str(e)}", "Vulnerability Scan Error")

        scan_doc.save()
        frappe.db.commit()

        return scan_doc

    def send_alert_email(self, scan_doc):
        """Send email alert if issues found"""
        recipients = frappe.db.get_single_value('Hosting Settings', 'alert_email')
        if not recipients:
            return

        subject = f"Security Alert: {self.website.domain} - {scan_doc.total_issues} Issues Found"

        message = f"""
		<h3>Vulnerability Scan Results for {self.website.domain}</h3>
		<p><b>Scan Date:</b> {scan_doc.scan_date}</p>
		<p><b>Total Issues:</b> {scan_doc.total_issues}</p>
		<ul>
			<li>Critical: {scan_doc.critical_issues}</li>
			<li>High: {scan_doc.high_issues}</li>
			<li>Medium: {scan_doc.medium_issues}</li>
			<li>Low: {scan_doc.low_issues}</li>
		</ul>
		<p><a href="/app/vulnerability-scan/{scan_doc.name}">View Full Report</a></p>
		"""

        frappe.sendmail(
                recipients=recipients,
                subject=subject,
                message=message
        )

    def scan_wordpress_version(self):
        """Check WordPress version for updates"""
        version_file = os.path.join(self.site_path, 'wp-includes/version.php')

        if not os.path.exists(version_file):
            self.results['wordpress'] = {'error': 'Not a WordPress site'}
            return

        # Extract current version
        with open(version_file, 'r') as f:
            content = f.read()
            match = re.search(r"\$wp_version = '([^']+)'", content)
            current_version = match.group(1) if match else 'Unknown'

        # Get latest version
        try:
            response = requests.get('https://api.wordpress.org/core/version-check/1.7/', timeout=10)
            data = response.json()
            latest_version = data['offers'][0]['version'] if data.get('offers') else 'Unknown'
        except (requests.RequestException, KeyError, ValueError):
            latest_version = 'Unknown'

        # Check if outdated
        is_outdated = current_version != latest_version and latest_version != 'Unknown'

        self.results['wordpress'] = {
                'current_version': current_version,
                'latest_version': latest_version,
                'is_outdated': is_outdated,
                'severity': 'high' if is_outdated else 'none'
        }

        if is_outdated:
            self.results['wordpress']['message'] = f'WordPress is outdated: {current_version} (latest: {latest_version})'

    def scan_plugin_vulnerabilities(self):
        """Check plugins for known vulnerabilities"""
        plugins_dir = os.path.join(self.site_path, 'wp-content/plugins')

        if not os.path.exists(plugins_dir):
            return

        plugins = []

        for plugin_dir in os.listdir(plugins_dir):
            plugin_path = os.path.join(plugins_dir, plugin_dir)

            if not os.path.isdir(plugin_path):
                continue

            # Find main plugin file
            for file in os.listdir(plugin_path):
                if file.endswith('.php'):
                    plugin_file = os.path.join(plugin_path, file)

                    # Extract version
                    try:
                        with open(plugin_file, 'r') as f:
                            content = f.read(2000)  # Read first 2KB
                            version_match = re.search(r'Version:\s*([0-9.]+)', content)
                            version = version_match.group(1) if version_match else 'Unknown'

                        plugins.append({
                                'name': plugin_dir,
                                'version': version,
                                'vulnerabilities': [],  # Would check WPScan API here
                                'severity': 'none'
                        })

                        break  # Only process first PHP file
                    except (OSError, UnicodeDecodeError):
                        continue

        self.results['plugins'] = plugins

    def scan_malware(self):
        """Scan for malware using ClamAV"""
        try:
            # Check if ClamAV is installed
            result = subprocess.run(['command', '-v', 'clamscan'], capture_output=True)
            if result.returncode != 0:
                self.results['malware'] = {'error': 'ClamAV not installed'}
                return

            # Run ClamAV scan
            result = subprocess.run([
                    'clamscan',
                    '-r',  # Recursive
                    '--infected',  # Only show infected files
                    '--no-summary',
                    self.site_path
            ], capture_output=True, text=True, timeout=300)  # 5 minute timeout

            # Parse results
            infected_files = []
            for line in result.stdout.split('\n'):
                if 'FOUND' in line:
                    parts = line.split(':')
                    if len(parts) >= 2:
                        infected_files.append({
                                'file': parts[0].strip(),
                                'threat': parts[1].strip(),
                                'severity': 'critical'
                        })

            self.results['malware'] = infected_files

        except subprocess.TimeoutExpired:
            self.results['malware'] = {'error': 'Scan timeout (site too large)'}
        except Exception as e:
            self.results['malware'] = {'error': str(e)}

    def scan_file_permissions(self):
        """Check for insecure file permissions"""
        issues = []

        try:
            # Find world-writable files
            result = subprocess.run([
                    'find', self.site_path,
                    '-type', 'f',
                    '-perm', '0777'
            ], capture_output=True, text=True, timeout=60)

            for file in result.stdout.strip().split('\n'):
                if file:
                    issues.append({
                            'file': file,
                            'issue': 'World-writable file (777)',
                            'severity': 'medium'
                    })

            # Find world-writable directories
            result = subprocess.run([
                    'find', self.site_path,
                    '-type', 'd',
                    '-perm', '0777'
            ], capture_output=True, text=True, timeout=60)

            for dir in result.stdout.strip().split('\n'):
                if dir and 'uploads' not in dir:  # Uploads dir can be 777
                    issues.append({
                            'file': dir,
                            'issue': 'World-writable directory (777)',
                            'severity': 'medium'
                    })

            self.results['permissions'] = issues

        except Exception as e:
            self.results['permissions'] = {'error': str(e)}

    def _calculate_severity_counts(self, scan_doc):
        """Calculate issue counts by severity"""
        critical = high = medium = low = 0

        # WordPress version
        if self.results['wordpress'].get('severity') == 'high':
            high += 1
            scan_doc.wordpress_version = self.results['wordpress']['current_version']
            scan_doc.latest_wordpress_version = self.results['wordpress']['latest_version']

        # Plugins
        scan_doc.plugins_scanned = len(self.results.get('plugins', []))
        vulnerable = sum(1 for p in self.results.get('plugins', []) if p.get('vulnerabilities'))
        scan_doc.vulnerable_plugins = vulnerable
        high += vulnerable

        # Malware
        if isinstance(self.results.get('malware'), list):
            malware_count = len(self.results['malware'])
            scan_doc.malware_detected = malware_count
            critical += malware_count

        # Permissions
        if isinstance(self.results.get('permissions'), list):
            perm_count = len(self.results['permissions'])
            scan_doc.permission_issues = perm_count
            medium += perm_count

        scan_doc.critical_issues = critical
        scan_doc.high_issues = high
        scan_doc.medium_issues = medium
        scan_doc.low_issues = low


# Whitelisted functions for UI

@frappe.whitelist()
def run_vulnerability_scan(website):
    """Run a vulnerability scan on a website"""
    scanner = VulnerabilityScanner(website)
    scan_doc = scanner.run_full_scan()
    return scan_doc.name


@frappe.whitelist()
def get_latest_scan(website):
    """Get the latest scan for a website"""
    scans = frappe.get_all(
            'Vulnerability Scan',
            filters={'website': website},
            fields=['name', 'scan_date', 'status', 'total_issues', 'critical_issues', 'high_issues'],
            order_by='scan_date desc',
            limit=1
    )

    return scans[0] if scans else None


@frappe.whitelist()
def schedule_daily_scans():
    """Schedule daily scans for all active websites"""
    websites = frappe.get_all(
            'Hosted Website',
            filters={'status': 'Active'},
            fields=['name']
    )

    for website in websites:
        # Check if scan is enabled for this website
        # (Would check a field on Hosted Website DocType)
        run_vulnerability_scan(website.name)

    return f"Scheduled scans for {len(websites)} websites"
